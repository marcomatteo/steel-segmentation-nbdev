---

title: Preprocessing


keywords: fastai
sidebar: home_sidebar

summary: "Make png mask for DL models."
description: "Make png mask for DL models."
nb_path: "02_preprocessing.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 02_preprocessing.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/opt/conda/envs/fastai/lib/python3.8/site-packages/torch/cuda/__init__.py:52: UserWarning: CUDA initialization: Found no NVIDIA driver on your system. Please check that you have an NVIDIA GPU and installed a driver from http://www.nvidia.com/Download/index.aspx (Triggered internally at  /pytorch/c10/cuda/CUDAFunctions.cpp:100.)
  return torch._C._cuda_getDeviceCount() &gt; 0
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For FastAI Segmentation DataLoader we need to build :</p>
<ol>
<li><p>the codes: the type of pixels in the images</p>
</li>
<li><p>the labels: the masks for each image</p>
</li>
<li><p>Cropping the images</p>
</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Codes-(opt.)">Codes (opt.)<a class="anchor-link" href="#Codes-(opt.)"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Codes are the labels for the corrisponding pixel values in the mask images.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">codes_file_name</span> <span class="o">=</span> <span class="s2">&quot;codes.txt&quot;</span>
<span class="n">codes_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="n">codes_file_name</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">codes_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">ClassId</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;codes.txt&#39;</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%u</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">codes_path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

<span class="n">classes</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([0, 1, 2, 3, 4], dtype=uint8)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Labels">Labels<a class="anchor-link" href="#Labels"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Labels are the masks for the training images.</p>
<p>As a first approach, i tried to create masks only for the images that present a defect. But this will exclude all the good images that can be used to teach to the model to recognize good steel pixels.</p>
<p>Now I created the masks for all the images in the training folder.</p>
<p><strong>NB: masks must be PNG files and not JPEG because JPEG's compression makes the labels get messed up occasionally</strong> (<a href="#https://forums.fast.ai/t/unet-learner-failing-with-a-cuda-device-assert/66747/4">source</a>)</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="create_masks" class="doc_header"><code>create_masks</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/preprocessing.py#L17" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>create_masks</code>(<strong><code>df</code></strong>:<code>DataFrame</code>)</p>
</blockquote>
<p>Create the mask files under the labels_dir</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">labels_dir</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
    <span class="n">labels_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">create_masks</span><span class="p">(</span><span class="n">train_all</span><span class="p">)</span>

<span class="n">labels_dir</span><span class="o">.</span><span class="n">ls</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#12568) [Path(&#39;data/labels/54fd0b997_P.png&#39;),Path(&#39;data/labels/5f5a2e357_P.png&#39;),Path(&#39;data/labels/3ab4ca44c_P.png&#39;),Path(&#39;data/labels/5b202c6f5_P.png&#39;),Path(&#39;data/labels/026183d85_P.png&#39;),Path(&#39;data/labels/5acf0f8cd_P.png&#39;),Path(&#39;data/labels/79b696401_P.png&#39;),Path(&#39;data/labels/65d8eae69_P.png&#39;),Path(&#39;data/labels/637a0124c_P.png&#39;),Path(&#39;data/labels/f95e24d0a_P.png&#39;)...]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>With the PNG extension, the multi-label segmentation problem would seem desappear.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mask_paths</span> <span class="o">=</span> <span class="n">get_image_files</span><span class="p">(</span><span class="n">labels_dir</span><span class="p">)</span>
<span class="n">dotest</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="n">dotest</span><span class="p">:</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_paths</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">get_random_idx</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">pixels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">mask_paths</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
        <span class="n">pixels_founded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
        <span class="n">pixels</span> <span class="o">=</span> <span class="n">pixels</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">pixels_founded</span><span class="p">))</span>
    <span class="n">pixels</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mask_paths</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#12568) [Path(&#39;data/labels/54fd0b997_P.png&#39;),Path(&#39;data/labels/5f5a2e357_P.png&#39;),Path(&#39;data/labels/3ab4ca44c_P.png&#39;),Path(&#39;data/labels/5b202c6f5_P.png&#39;),Path(&#39;data/labels/026183d85_P.png&#39;),Path(&#39;data/labels/5acf0f8cd_P.png&#39;),Path(&#39;data/labels/79b696401_P.png&#39;),Path(&#39;data/labels/65d8eae69_P.png&#39;),Path(&#39;data/labels/637a0124c_P.png&#39;),Path(&#39;data/labels/f95e24d0a_P.png&#39;)...]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Cropping">Cropping<a class="anchor-link" href="#Cropping"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The standard size of the images is <code>(256, 1600)</code> and maybe it's because of this that I always go out of memory in the GPU.</p>

</div>
</div>
</div>
</div>
 

