---

title: Trainer


keywords: fastai
sidebar: home_sidebar

summary: "Train classes for Deep Learning models with Fastai/Pytorch."
description: "Train classes for Deep Learning models with Fastai/Pytorch."
nb_path: "nbs/06_trainer.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/06_trainer.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">models_dir</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;models&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In the Paperspace Gradient machine I stored these models:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_competition_data</span><span class="p">(</span><span class="n">models_dir</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>../models/ResNet50_class.pt
../models/ResNet18_class.pt
../models/ResNet18-Unet-128-stage2.pth
../models/ResNet18-Unet-128-stage3.pth
../models/ResNet34-Unet-256-stage1.pth
../models/ResNet34-Unet-256-stage3.pth
../models/ResNet18-Unet-128-stage1.pth
../models/ResNet34-Unet-256-stage2.pth
../models/Resnet50-stage1.pth
../models/ResNet18-Unet-256-stage2.pth
../models/ResNet18-Unet-kaggle.pth
../models/ResNet18-Unet-256-stage3.pth
../models/ResNet18-Unet-256-stage1.pth
../models/ResNet34-Unet-128-stage3.pth
../models/ResNet34-Unet-128-stage2.pth
../models/ResNet34-stage1.pth
../models/ResNet18-stage1.pth
../models/ResNet34_class.pt
../models/kaggle_model.pth
../models/ResNet18-kaggle-class.pth
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Fast.ai-Classification">Fast.ai Classification<a class="anchor-link" href="#Fast.ai-Classification"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">class_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">accuracy_multi</span><span class="p">,</span> <span class="n">PrecisionMulti</span><span class="p">(),</span> <span class="n">RecallMulti</span><span class="p">()]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>An example to train fast.ai models with a classification <code>Learner</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bs</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">dls</span> <span class="o">=</span> <span class="n">get_classification_dls</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span>
<span class="n">arch</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">resnet18</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">class_learner</span> <span class="o">=</span> <span class="n">cnn_learner</span><span class="p">(</span>
    <span class="n">dls</span><span class="o">=</span><span class="n">dls</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="n">arch</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">class_metrics</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Fast.ai-Segmentation">Fast.ai Segmentation<a class="anchor-link" href="#Fast.ai-Segmentation"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First we create a classification model to get an encoder that know how to classify defects pixels.
Then, we build a UNet from the trained encoder and train a segmentation model.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">seg_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">ModDiceMulti</span><span class="p">(),</span> <span class="n">dice_kaggle</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>An example to train fast.ai models with a segmentation <code>Learner</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bs</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">szs</span> <span class="o">=</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">800</span><span class="p">)</span>

<span class="c1">#dls = get_segmentation_dls_from_df(train_multi, bs, szs)</span>
<span class="n">dls</span> <span class="o">=</span> <span class="n">get_segmentation_dls</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">szs</span><span class="p">)</span>
<span class="n">segmentation_learner</span> <span class="o">=</span> <span class="n">unet_learner</span><span class="p">(</span>
    <span class="n">dls</span><span class="o">=</span><span class="n">dls</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="n">resnet18</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">seg_metrics</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">segmentation_learner</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/storage/steel_segmentation/steel_segmentation/metrics.py:53: RuntimeWarning: Mean of empty slice
  return np.nanmean(binary_dice_scores)
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>DynamicUnet (Input shape: 4)
============================================================================
Layer (type)         Output Shape         Param #    Trainable 
============================================================================
                     4 x 64 x 64 x 400   
Conv2d                                    9408       False     
BatchNorm2d                               128        True      
ReLU                                                           
MaxPool2d                                                      
Conv2d                                    36864      False     
BatchNorm2d                               128        True      
ReLU                                                           
Conv2d                                    36864      False     
BatchNorm2d                               128        True      
Conv2d                                    36864      False     
BatchNorm2d                               128        True      
ReLU                                                           
Conv2d                                    36864      False     
BatchNorm2d                               128        True      
____________________________________________________________________________
                     4 x 128 x 16 x 100  
Conv2d                                    73728      False     
BatchNorm2d                               256        True      
ReLU                                                           
Conv2d                                    147456     False     
BatchNorm2d                               256        True      
Conv2d                                    8192       False     
BatchNorm2d                               256        True      
Conv2d                                    147456     False     
BatchNorm2d                               256        True      
ReLU                                                           
Conv2d                                    147456     False     
BatchNorm2d                               256        True      
____________________________________________________________________________
                     4 x 256 x 8 x 50    
Conv2d                                    294912     False     
BatchNorm2d                               512        True      
ReLU                                                           
Conv2d                                    589824     False     
BatchNorm2d                               512        True      
Conv2d                                    32768      False     
BatchNorm2d                               512        True      
Conv2d                                    589824     False     
BatchNorm2d                               512        True      
ReLU                                                           
Conv2d                                    589824     False     
BatchNorm2d                               512        True      
____________________________________________________________________________
                     4 x 512 x 4 x 25    
Conv2d                                    1179648    False     
BatchNorm2d                               1024       True      
ReLU                                                           
Conv2d                                    2359296    False     
BatchNorm2d                               1024       True      
Conv2d                                    131072     False     
BatchNorm2d                               1024       True      
Conv2d                                    2359296    False     
BatchNorm2d                               1024       True      
ReLU                                                           
Conv2d                                    2359296    False     
BatchNorm2d                               1024       True      
BatchNorm2d                               1024       True      
ReLU                                                           
____________________________________________________________________________
                     4 x 1024 x 4 x 25   
Conv2d                                    4719616    True      
ReLU                                                           
____________________________________________________________________________
                     4 x 512 x 4 x 25    
Conv2d                                    4719104    True      
ReLU                                                           
____________________________________________________________________________
                     4 x 1024 x 4 x 25   
Conv2d                                    525312     True      
ReLU                                                           
PixelShuffle                                                   
BatchNorm2d                               512        True      
Conv2d                                    2359808    True      
ReLU                                                           
Conv2d                                    2359808    True      
ReLU                                                           
ReLU                                                           
____________________________________________________________________________
                     4 x 1024 x 8 x 50   
Conv2d                                    525312     True      
ReLU                                                           
PixelShuffle                                                   
BatchNorm2d                               256        True      
Conv2d                                    1327488    True      
ReLU                                                           
Conv2d                                    1327488    True      
ReLU                                                           
ReLU                                                           
____________________________________________________________________________
                     4 x 768 x 16 x 100  
Conv2d                                    295680     True      
ReLU                                                           
PixelShuffle                                                   
BatchNorm2d                               128        True      
Conv2d                                    590080     True      
ReLU                                                           
Conv2d                                    590080     True      
ReLU                                                           
ReLU                                                           
____________________________________________________________________________
                     4 x 512 x 32 x 200  
Conv2d                                    131584     True      
ReLU                                                           
PixelShuffle                                                   
BatchNorm2d                               128        True      
____________________________________________________________________________
                     4 x 96 x 64 x 400   
Conv2d                                    165984     True      
ReLU                                                           
Conv2d                                    83040      True      
ReLU                                                           
ReLU                                                           
____________________________________________________________________________
                     4 x 384 x 64 x 400  
Conv2d                                    37248      True      
ReLU                                                           
PixelShuffle                                                   
ResizeToOrig                                                   
MergeLayer                                                     
Conv2d                                    88308      True      
ReLU                                                           
Conv2d                                    88308      True      
Sequential                                                     
ReLU                                                           
____________________________________________________________________________
                     4 x 5 x 128 x 800   
Conv2d                                    500        True      
____________________________________________________________________________

Total params: 31,113,308
Total trainable params: 19,946,396
Total non-trainable params: 11,166,912

Optimizer used: &lt;function Adam at 0x7f651f0eb9d0&gt;
Loss function: FlattenedLoss of CrossEntropyLoss()

Model frozen up to parameter group #2

Callbacks:
  - TrainEvalCallback
  - Recorder
  - ProgressCallback</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To load custom weights in the Unet Encoder:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">encoder_path</span> <span class="o">=</span> <span class="n">models_dir</span> <span class="o">/</span> <span class="s2">&quot;ResNet18-2_class.pt&quot;</span>
<span class="n">segmentation_learner</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">encoder_path</span><span class="p">),</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Pytorch-Trainer">Pytorch Trainer<a class="anchor-link" href="#Pytorch-Trainer"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The code in this project is not only FastAi. I based an alternative solution based on this <a href="https://www.kaggle.com/rishabhiitbhu/unet-starter-kernel-pytorch-lb-0-88">kernel</a>. 
In this notebook I will go through each part of the model from that kernel.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="seed_everything" class="doc_header"><code>seed_everything</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/trainer.py#L46" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>seed_everything</code>(<strong><code>seed</code></strong>=<em><code>69</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">seed_everything</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">smp</span><span class="o">.</span><span class="n">Unet</span><span class="p">(</span><span class="s2">&quot;resnet18&quot;</span><span class="p">,</span> 
                 <span class="n">encoder_weights</span><span class="o">=</span><span class="s2">&quot;imagenet&quot;</span><span class="p">,</span> 
                 <span class="n">classes</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> 
                 <span class="n">activation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Trainer" class="doc_header"><code>class</code> <code>Trainer</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/trainer.py#L55" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Trainer</code>(<strong><code>model</code></strong>, <strong><code>save_path</code></strong>, <strong><code>num_epochs</code></strong>=<em><code>20</code></em>, <strong><code>lr</code></strong>=<em><code>0.0005</code></em>, <strong><code>bs</code></strong>=<em><code>16</code></em>, <strong><code>num_workers</code></strong>=<em><code>6</code></em>)</p>
</blockquote>
<p>This class takes care of training and validation of our model</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Trainer.__init__" class="doc_header"><code>Trainer.__init__</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/trainer.py#L58" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Trainer.__init__</code>(<strong><code>model</code></strong>, <strong><code>save_path</code></strong>, <strong><code>num_epochs</code></strong>=<em><code>20</code></em>, <strong><code>lr</code></strong>=<em><code>0.0005</code></em>, <strong><code>bs</code></strong>=<em><code>16</code></em>, <strong><code>num_workers</code></strong>=<em><code>6</code></em>)</p>
</blockquote>
<p>Initialize self.  See help(type(self)) for accurate signature.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Trainer.forward" class="doc_header"><code>Trainer.forward</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/trainer.py#L94" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Trainer.forward</code>(<strong><code>images</code></strong>, <strong><code>targets</code></strong>)</p>
</blockquote>
<p>Forward pass:
    load to GPU the imgs and masks,
    calculate predictions,
    calculate loss</p>
<p>Returns:
    loss and predictions</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Trainer.iterate" class="doc_header"><code>Trainer.iterate</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/trainer.py#L110" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Trainer.iterate</code>(<strong><code>epoch</code></strong>, <strong><code>phase</code></strong>)</p>
</blockquote>
<p>Iterate throught each batch in training or validation phase.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Trainer.start" class="doc_header"><code>Trainer.start</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/trainer.py#L150" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Trainer.start</code>()</p>
</blockquote>
<p>Training loop for each epochs.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model_trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

