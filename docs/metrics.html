---

title: Metrics


keywords: fastai
sidebar: home_sidebar

summary: "A collection of Metrics used in the segmentation models"
description: "A collection of Metrics used in the segmentation models"
nb_path: "nbs/05_metrics.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/05_metrics.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="https://colab.research.google.com/github/marcomatteo/steel_segmentation/blob/master/dev_nbs/05_metrics.ipynb"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In this section there are all the metric used to evaluate the performances of the deep learning models.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="n">dls</span> <span class="o">=</span> <span class="n">get_segmnt_dls</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">x</span><span class="p">,</span> <span class="n">targs</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">targs</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(torch.Size([20, 3, 256, 256]), torch.Size([20, 4, 256, 256]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
<span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">targs</span><span class="o">.</span><span class="n">device</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(device(type=&#39;cpu&#39;), device(type=&#39;cpu&#39;))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">smp</span><span class="o">.</span><span class="n">Unet</span><span class="p">(</span><span class="s2">&quot;resnet18&quot;</span><span class="p">,</span> 
                 <span class="n">encoder_weights</span><span class="o">=</span><span class="s2">&quot;imagenet&quot;</span><span class="p">,</span> 
                 <span class="n">classes</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> 
                 <span class="n">activation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">preds</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<span class="n">preds</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>torch.Size([20, 4, 256, 256])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Metrics-for-fastai-API">Metrics for fastai API<a class="anchor-link" href="#Metrics-for-fastai-API"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Some code from the fastai docs to test properly the metrics:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@delegates</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">TstLearner</span><span class="p">(</span><span class="n">Learner</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">xb</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">yb</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
        
<span class="c1">#Go through a fake cycle with various batch sizes and computes the value of met</span>
<span class="k">def</span> <span class="nf">compute_val</span><span class="p">(</span><span class="n">met</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
    <span class="n">met</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">20</span><span class="p">]</span>
    <span class="n">learn</span> <span class="o">=</span> <span class="n">TstLearner</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">learn</span><span class="o">.</span><span class="n">pred</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">learn</span><span class="o">.</span><span class="n">yb</span> <span class="o">=</span> <span class="p">(</span> <span class="n">x2</span><span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]],</span> <span class="p">)</span>
        <span class="n">met</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">learn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">met</span><span class="o">.</span><span class="n">value</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ModDiceMulti" class="doc_header"><code>class</code> <code>ModDiceMulti</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L22" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ModDiceMulti</code>(<strong><code>axis</code></strong>=<em><code>1</code></em>) :: <code>Metric</code></p>
</blockquote>
<p>Averaged Dice metric (Macro F1) for multiclass target in segmentation</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dice_obj</span> <span class="o">=</span> <span class="n">ModDiceMulti</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">compute_val</span><span class="p">(</span><span class="n">dice_obj</span><span class="p">,</span> <span class="n">targs</span><span class="p">,</span> <span class="n">preds</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.2149896941194403</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For test purpose, we create a tensor, <code>x1</code>, as a prediction for the first channel.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x1a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">x1b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">x1a</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span>
<span class="n">x1c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">x1a</span><span class="p">)</span><span class="o">*</span><span class="mf">0.3</span>
<span class="n">x1d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">x1a</span><span class="p">)</span><span class="o">*</span><span class="mf">0.1</span>

<span class="n">x1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x1a</span><span class="p">,</span><span class="n">x1b</span><span class="p">,</span><span class="n">x1c</span><span class="p">,</span><span class="n">x1d</span><span class="p">),</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># Prediction: 20x4</span>
<span class="n">x1</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>torch.Size([20, 4, 1, 1])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The target is a flatten mask, used by fastai segmentation models.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Target: 20xClass0</span>
<span class="n">x2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span> <span class="n">x2</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(tensor([[[0.]],
 
         [[0.]],
 
         [[0.]],
 
         [[0.]],
 
         [[0.]]]),
 torch.Size([20, 1, 1]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Test of <code>DiceMulti</code> into a simulated training with <code>compute_val</code> and a test Learner with <code>TstLearner</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">compute_val</span><span class="p">(</span><span class="n">dice_obj</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">),</span> <span class="mf">1.</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Target: 20xClass1</span>
<span class="c1"># Dice metric = 0</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">compute_val</span><span class="p">(</span><span class="n">dice_obj</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">),</span> <span class="mf">0.</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Different scenario with a multiclass batch:</p>
<ul>
<li>Class0 x 10</li>
<li>Class1 x 4</li>
<li>Class2 x 3</li>
<li>Class4 x 3</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x2a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">x2b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">x2c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
<span class="n">x2d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span>

<span class="n">x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x2a</span><span class="p">,</span><span class="n">x2b</span><span class="p">,</span><span class="n">x2c</span><span class="p">,</span><span class="n">x2d</span><span class="p">),</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>   <span class="c1"># Target: 10xClass0, 4xClass1, 3xClass2, 3xClass4</span>
<span class="n">x2</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>torch.Size([20, 1, 1])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dice1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">10</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="mi">3</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span>              <span class="c1"># Dice: 2*TP/(2*TP+FP+FN)</span>
<span class="n">dice2</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">dice3</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">dice4</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># Value to be tested</span>
<span class="n">computed_dice</span> <span class="o">=</span> <span class="n">compute_val</span><span class="p">(</span><span class="n">dice_obj</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
<span class="c1"># Dice metric = 0.1666</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">computed_dice</span><span class="p">,</span> <span class="p">(</span><span class="n">dice1</span><span class="o">+</span><span class="n">dice2</span><span class="o">+</span><span class="n">dice3</span><span class="o">+</span><span class="n">dice4</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="p">[</span><span class="n">dice1</span><span class="p">,</span> <span class="n">dice2</span><span class="p">,</span> <span class="n">dice3</span><span class="p">,</span> <span class="n">dice4</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">computed_dice</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[[0.6666666666666666, 0, 0, 0]]
0.16666666666666666
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dice_obj</span><span class="o">.</span><span class="n">inter</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{0: 10.0, 1: 0.0, 2: 0.0, 3: 0.0}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dice_obj</span><span class="o">.</span><span class="n">union</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{0: 30.0, 1: 4.0, 2: 3.0, 3: 3.0}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">binary_dice_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">dice_obj</span><span class="o">.</span><span class="n">inter</span><span class="p">:</span>
    <span class="n">binary_dice_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">binary_dice_scores</span><span class="p">,</span> 
        <span class="mf">2.</span><span class="o">*</span><span class="n">dice_obj</span><span class="o">.</span><span class="n">inter</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">/</span><span class="n">dice_obj</span><span class="o">.</span><span class="n">union</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> 
        <span class="k">if</span> <span class="n">dice_obj</span><span class="o">.</span><span class="n">union</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">binary_dice_scores</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([0.66666667, 0.        , 0.        , 0.        ])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">binary_dice_scores</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.16666666666666666</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="KaggleDice" class="doc_header"><code>class</code> <code>KaggleDice</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L58" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>KaggleDice</code>(<strong><code>axis</code></strong>=<em><code>1</code></em>, <strong><code>eps</code></strong>=<em><code>1e-09</code></em>) :: <code>Metric</code></p>
</blockquote>
<p>Blueprint for defining a metric</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The competition "Evaluation" metric is defined as:</p>
<blockquote><p>This competition is evaluated on the mean Dice coefficient. The Dice coefficient can be used to compare the pixel-wise agreement between a predicted segmentation and its corresponding ground truth. The formula is given by:$$J(A,B) = \frac{2 * |A \cap B|}{|A| \cup |B|}
$$</p>
<p>where X is the predicted set of pixels and Y is the ground truth. The Dice coefficient is defined to be 1 when both X and Y are empty. The leaderboard score is the mean of the Dice coefficients for each &lt;ImageId, ClassId&gt; pair in the test set.</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dice_kaggle_obj</span> <span class="o">=</span> <span class="n">KaggleDice</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">computed_kaggle_dice</span> <span class="o">=</span> <span class="n">compute_val</span><span class="p">(</span><span class="n">dice_kaggle_obj</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">);</span> <span class="n">computed_kaggle_dice</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.7500000005</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Test for <a href="/steel_segmentation/metrics.html#KaggleDice"><code>KaggleDice</code></a>:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">20</span><span class="p">]</span>
<span class="n">intersect</span><span class="p">,</span> <span class="n">union</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span><span class="n">vals</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="n">targ</span> <span class="o">=</span> <span class="p">(</span> <span class="n">x2</span><span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span><span class="n">vals</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="p">)</span>
    <span class="n">targ</span> <span class="o">=</span> <span class="n">targ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-9</span>
    <span class="c1"># pred.shape, targ.shape</span>

    <span class="k">if</span> <span class="n">pred</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">targ</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="n">targ</span> <span class="o">=</span> <span class="n">targ</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">targ</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># n, c</span>

    <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">targ</span> <span class="o">=</span> <span class="n">targ</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># pred.shape, targ.shape</span>
    <span class="c1"># pred.max(), targ.max()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pred</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">targ</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">p</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">TensorBase</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">TensorBase</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">c_inter</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="c1">#.item()</span>
        <span class="n">c_union</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="c1">#.item()</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">intersect</span><span class="p">:</span>
            <span class="n">intersect</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">intersect</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">c_inter</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">union</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">union</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">c_union</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">intersect</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_inter</span>
            <span class="n">union</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_union</span>
    <span class="c1">#     print(f&quot;Iter n.{i}\nintersect: {intersect[i]}\nunion: {union[i]}&quot;, end=&quot;\n\n&quot;)</span>

<span class="n">binary_dice_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">intersect</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="n">union</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">val</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">intersect</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">+</span><span class="n">eps</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">union</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">+</span><span class="n">eps</span><span class="p">)</span>
    <span class="n">val</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">binary_dice_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">binary_dice_scores</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

<span class="n">num</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">binary_dice_scores</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="mi">20</span><span class="p">):((</span><span class="n">i</span><span class="o">*</span><span class="mi">20</span><span class="p">)</span><span class="o">+</span><span class="mi">20</span><span class="p">)])</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=.</span><span class="mi">6</span><span class="p">,</span> <span class="n">pad</span><span class="o">=-</span><span class="mf">7.</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">binary_dice_scores</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>0.7500000005
</pre>
</div>
</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
"
>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_close</span><span class="p">(</span><span class="n">computed_kaggle_dice</span><span class="p">,</span> <span class="n">binary_dice_scores</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Test <a href="/steel_segmentation/metrics.html#KaggleDice"><code>KaggleDice</code></a> with a real shape batch:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">chs</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">x3a</span> <span class="o">=</span> <span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">chs</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">0.65</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">x3b</span> <span class="o">=</span> <span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">chs</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">0.65</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">x3c</span> <span class="o">=</span> <span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">chs</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">0.65</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">x3d</span> <span class="o">=</span> <span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">chs</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">0.65</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">x3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x3a</span><span class="p">,</span><span class="n">x3b</span><span class="p">,</span><span class="n">x3c</span><span class="p">,</span><span class="n">x3d</span><span class="p">),</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span> <span class="n">x3</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>torch.Size([20, 4, 1, 1])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x4a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">x4b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">x4c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">x4d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">x4e</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">x4</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x4a</span><span class="p">,</span><span class="n">x4b</span><span class="p">,</span><span class="n">x4c</span><span class="p">,</span><span class="n">x4d</span><span class="p">,</span> <span class="n">x4e</span><span class="p">),</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>   <span class="c1"># Target: 5xClass0, 5xClass1, 5xClass2, 5xClass4</span>
<span class="n">x4</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>torch.Size([20, 4, 1])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">computed_kaggle_dice</span> <span class="o">=</span> <span class="n">compute_val</span><span class="p">(</span><span class="n">dice_kaggle_obj</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">x4</span><span class="p">);</span> <span class="n">computed_kaggle_dice</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.5696428585634757</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">20</span><span class="p">]</span>
<span class="n">intersect</span><span class="p">,</span> <span class="n">union</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">x3</span><span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span><span class="n">vals</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="n">targ</span> <span class="o">=</span> <span class="p">(</span> <span class="n">x4</span><span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span><span class="n">vals</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="p">)</span>
    <span class="n">targ</span> <span class="o">=</span> <span class="n">targ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-9</span>

    <span class="k">if</span> <span class="n">pred</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">targ</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="n">targ</span> <span class="o">=</span> <span class="n">targ</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">targ</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">targ</span> <span class="o">=</span> <span class="n">targ</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pred</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">targ</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">p</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">TensorBase</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">TensorBase</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">c_inter</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="c1">#.item()</span>
        <span class="n">c_union</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="c1">#.item()</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">intersect</span><span class="p">:</span>
            <span class="n">intersect</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">intersect</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">c_inter</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">union</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">union</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">c_union</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">intersect</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_inter</span>
            <span class="n">union</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_union</span>

<span class="n">binary_dice_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">intersect</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="n">union</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">val</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">intersect</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">+</span><span class="n">eps</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">union</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">+</span><span class="n">eps</span><span class="p">)</span>
    <span class="n">val</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">binary_dice_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">binary_dice_scores</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

<span class="n">num</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">binary_dice_scores</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="mi">20</span><span class="p">):((</span><span class="n">i</span><span class="o">*</span><span class="mi">20</span><span class="p">)</span><span class="o">+</span><span class="mi">20</span><span class="p">)])</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=.</span><span class="mi">6</span><span class="p">,</span> <span class="n">pad</span><span class="o">=-</span><span class="mf">7.</span><span class="p">)</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">computed_kaggle_dice</span><span class="p">,</span> <span class="n">binary_dice_scores</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">binary_dice_scores</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>0.5696428585634757
</pre>
</div>
</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
"
>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Real masks have a problem with the hardnegatives examples.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># with real batch, recompute cell above to test</span>
<span class="n">x3</span><span class="p">,</span> <span class="n">x4</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">targs</span>
<span class="n">x3</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">x4</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(torch.Size([20, 4, 256, 256]), torch.Size([20, 4, 256, 256]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="dice_kaggle" class="doc_header"><code>dice_kaggle</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L103" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>dice_kaggle</code>(<strong><code>preds</code></strong>:<code>Tensor</code>, <strong><code>targs</code></strong>:<code>Tensor</code>, <strong><code>iou</code></strong>:<code>bool</code>=<em><code>False</code></em>, <strong><code>eps</code></strong>:<code>float</code>=<em><code>1e-08</code></em>)</p>
</blockquote>
<p>The metric of the competition,
if there's no defect in <code>targs</code> and no defects in <code>preds</code>: dice=1.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dice_kag</span> <span class="o">=</span> <span class="n">dice_kaggle</span><span class="p">(</span><span class="n">x3</span><span class="p">,</span> <span class="n">x4</span><span class="p">)</span>
<span class="n">dice_kag</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>TensorBase(0.6838)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_ne</span><span class="p">(</span><span class="n">computed_kaggle_dice</span><span class="p">,</span> <span class="n">dice_kag</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Intersection-Over-Union">Intersection Over Union<a class="anchor-link" href="#Intersection-Over-Union"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="iou" class="doc_header"><code>iou</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L140" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>iou</code>(<strong><code>outputs</code></strong>:<code>Tensor</code>, <strong><code>targets</code></strong>:<code>Tensor</code>, <strong><code>eps</code></strong>:<code>float</code>=<em><code>1e-07</code></em>, <strong><code>threshold</code></strong>:<code>float</code>=<em><code>None</code></em>, <strong><code>activation</code></strong>:<code>str</code>=<em><code>'Sigmoid'</code></em>)</p>
</blockquote>
<p><a href="https://github.com/catalyst-team/catalyst/blob/master/catalyst/dl/utils/criterion/iou.py">https://github.com/catalyst-team/catalyst/blob/master/catalyst/dl/utils/criterion/iou.py</a>
Args:
    outputs (torch.Tensor): A list of predicted elements
    targets (torch.Tensor):  A list of elements that are to be predicted
    eps (float): epsilon to avoid zero division
    threshold (float): threshold for outputs binarization
    activation (str): An torch.nn activation applied to the outputs.
        Must be one of ["none", "Sigmoid", "Softmax2d"]
Returns:
    float: IoU (Jaccard) score</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">iou</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">targs</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>TensorMask(0.0212)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">jacc_metric</span> <span class="o">=</span> <span class="n">JaccardCoeff</span><span class="p">()</span>
<span class="n">compute_val</span><span class="p">(</span><span class="n">jacc_metric</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">targs</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.16245156865134813</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="iou_binary_metric" class="doc_header"><code>iou_binary_metric</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L171" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>iou_binary_metric</code>(<strong><code>preds</code></strong>, <strong><code>labels</code></strong>, <strong><code>EMPTY</code></strong>=<em><code>1.0</code></em>, <strong><code>ignore</code></strong>=<em><code>None</code></em>, <strong><code>per_image</code></strong>=<em><code>True</code></em>)</p>
</blockquote>
<p>IoU for foreground class
binary: 1 foreground, 0 background</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="iou_metric" class="doc_header"><code>iou_metric</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L191" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>iou_metric</code>(<strong><code>preds</code></strong>, <strong><code>labels</code></strong>, <strong><code>C</code></strong>, <strong><code>EMPTY</code></strong>=<em><code>1.0</code></em>, <strong><code>ignore</code></strong>=<em><code>None</code></em>, <strong><code>per_image</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Array of IoU for each (non ignored) class</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="compute_ious" class="doc_header"><code>compute_ious</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L214" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>compute_ious</code>(<strong><code>pred</code></strong>, <strong><code>label</code></strong>, <strong><code>classes</code></strong>, <strong><code>ignore_index</code></strong>=<em><code>255</code></em>, <strong><code>only_present</code></strong>=<em><code>True</code></em>)</p>
</blockquote>
<p>computes IoU for one ground truth mask and predicted mask</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">compute_ious</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">targs</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">classes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">only_present</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.17859625766795872</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">compute_ious</span><span class="p">(</span><span class="n">x1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">x3</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">classes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">only_present</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[0.0, 0.25, 1, 1]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">compute_ious</span><span class="p">(</span><span class="n">x1</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">x3</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">classes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">only_present</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[0.0, 0.25, 1, 1]
[0.0, 0.0, 1, 1]
[0.0, 0.0, 1, 1]
[0.0, 0.0, 1, 1]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="compute_iou_batch" class="doc_header"><code>compute_iou_batch</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L233" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>compute_iou_batch</code>(<strong><code>outputs</code></strong>, <strong><code>labels</code></strong>, <strong><code>classes</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>computes mean iou for a batch of ground truth masks and predicted masks</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">compute_iou_batch</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">targs</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.2520990513663458</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Dice">Dice<a class="anchor-link" href="#Dice"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="dice" class="doc_header"><code>dice</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L244" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>dice</code>(<strong><code>outputs</code></strong>:<code>Tensor</code>, <strong><code>targets</code></strong>:<code>Tensor</code>, <strong><code>eps</code></strong>:<code>float</code>=<em><code>1e-07</code></em>, <strong><code>threshold</code></strong>:<code>float</code>=<em><code>None</code></em>)</p>
</blockquote>
<p>Computes the binary dice metric
Args:
    outputs (list):  A list of predicted elements
    targets (list): A list of elements that are to be predicted
    eps (float): epsilon
    threshold (float): threshold for outputs binarization
Returns:
    double:  Dice score</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here there'are some functions used by the pure pytorch solution from a kaggle kernel.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="metric" class="doc_header"><code>metric</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L272" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>metric</code>(<strong><code>probability</code></strong>, <strong><code>truth</code></strong>, <strong><code>threshold</code></strong>=<em><code>0.5</code></em>, <strong><code>reduction</code></strong>=<em><code>'none'</code></em>)</p>
</blockquote>
<p>Calculates dice of positive and negative images seperately
<code>probability</code> and <code>truth</code> must be <code>torch.Tensors</code>.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">metric</span><span class="p">(</span><span class="n">x3</span><span class="p">,</span> <span class="n">x4</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([[0.0000],
        [0.0000],
        [0.0000],
        [0.0000],
        [0.0000],
        [0.0000],
        [0.0000],
        [0.0000],
        [0.0000],
        [0.0000],
        [0.6667],
        [0.6667],
        [0.6667],
        [0.6667],
        [0.6667],
        [1.0000],
        [1.0000],
        [1.0000],
        [0.0000],
        [0.0000]])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="predict" class="doc_header"><code>predict</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L304" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>predict</code>(<strong><code>X</code></strong>, <strong><code>threshold</code></strong>)</p>
</blockquote>
<p>X is sigmoid output of the model</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Meter" class="doc_header"><code>class</code> <code>Meter</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L311" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Meter</code>(<strong><code>phase</code></strong>, <strong><code>epoch</code></strong>)</p>
</blockquote>
<p>A meter to keep track of iou and dice scores throughout an epoch</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Meter.get_metrics" class="doc_header"><code>Meter.get_metrics</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L333" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Meter.get_metrics</code>()</p>
</blockquote>
<p>Calc the mean of dices metrics (dice, dice_neg, dice_pos)
and IoU mean.</p>
<p>Returns:
    <code>dices</code> as list of means <code>[dice, dice_neg, dice_pos]</code>,
    <a href="/steel_segmentation/metrics.html#iou"><code>iou</code></a> as mean of IoUs</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="epoch_log" class="doc_header"><code>epoch_log</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L352" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>epoch_log</code>(<strong><code>phase</code></strong>, <strong><code>epoch</code></strong>, <strong><code>epoch_loss</code></strong>, <strong><code>meter</code></strong>, <strong><code>start</code></strong>)</p>
</blockquote>
<p>logging the metrics at the end of an epoch</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

