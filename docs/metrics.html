---

title: Metrics


keywords: fastai
sidebar: home_sidebar

summary: "A collection of Metrics used in the segmentation models"
description: "A collection of Metrics used in the segmentation models"
nb_path: "nbs/05_metrics.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/05_metrics.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="https://colab.research.google.com/github/marcomatteo/steel_segmentation/blob/master/dev_nbs/05_metrics.ipynb"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In this section there are all the metric used to evaluate the performances of the deep learning models.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">get_segmnt_dls</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">x</span><span class="p">,</span> <span class="n">targs</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">targs</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(torch.Size([20, 3, 256, 256]), torch.Size([20, 4, 256, 256]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">targs</span><span class="o">.</span><span class="n">device</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(device(type=&#39;cuda&#39;, index=0), device(type=&#39;cpu&#39;))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">smp</span><span class="o">.</span><span class="n">Unet</span><span class="p">(</span><span class="s2">&quot;resnet18&quot;</span><span class="p">,</span> 
                 <span class="n">encoder_weights</span><span class="o">=</span><span class="s2">&quot;imagenet&quot;</span><span class="p">,</span> 
                 <span class="n">classes</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> 
                 <span class="n">activation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="n">preds</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<span class="n">preds</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>torch.Size([20, 4, 256, 256])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">preds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>TensorImage([[1., 1., 1.,  ..., 1., 1., 1.],
        [1., 1., 1.,  ..., 1., 1., 1.],
        [1., 1., 1.,  ..., 1., 1., 0.],
        ...,
        [0., 1., 1.,  ..., 1., 1., 1.],
        [1., 1., 1.,  ..., 1., 1., 1.],
        [1., 1., 1.,  ..., 1., 0., 1.]], device=&#39;cuda:0&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Metrics-for-fastai-API">Metrics for fastai API<a class="anchor-link" href="#Metrics-for-fastai-API"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Some code from the fastai docs to test properly the metrics:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@delegates</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">TstLearner</span><span class="p">(</span><span class="n">Learner</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">xb</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">yb</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
        
<span class="c1">#Go through a fake cycle with various batch sizes and computes the value of met</span>
<span class="k">def</span> <span class="nf">compute_val</span><span class="p">(</span><span class="n">met</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
    <span class="n">met</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">20</span><span class="p">]</span>
    <span class="n">learn</span> <span class="o">=</span> <span class="n">TstLearner</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">learn</span><span class="o">.</span><span class="n">pred</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">learn</span><span class="o">.</span><span class="n">yb</span> <span class="o">=</span> <span class="p">(</span> <span class="n">x2</span><span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]],</span> <span class="p">)</span>
        <span class="n">met</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">learn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">met</span><span class="o">.</span><span class="n">value</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ModDiceMulti" class="doc_header"><code>class</code> <code>ModDiceMulti</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L24" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ModDiceMulti</code>(<strong><code>axis</code></strong>=<em><code>1</code></em>) :: <code>Metric</code></p>
</blockquote>
<p>Averaged Dice metric (Macro F1) for multiclass target in segmentation</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dice_obj</span> <span class="o">=</span> <span class="n">ModDiceMulti</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">compute_val</span><span class="p">(</span><span class="n">dice_obj</span><span class="p">,</span> <span class="n">targs</span><span class="p">,</span> <span class="n">preds</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.2078039329916666</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For test purpose, we create a tensor, <code>x1</code>, as a prediction for the first channel.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x1a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">x1b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">x1a</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span>
<span class="n">x1c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">x1a</span><span class="p">)</span><span class="o">*</span><span class="mf">0.3</span>
<span class="n">x1d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">x1a</span><span class="p">)</span><span class="o">*</span><span class="mf">0.1</span>

<span class="n">x1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x1a</span><span class="p">,</span><span class="n">x1b</span><span class="p">,</span><span class="n">x1c</span><span class="p">,</span><span class="n">x1d</span><span class="p">),</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># Prediction: 20x4</span>
<span class="n">x1</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>torch.Size([20, 4, 1, 1])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The target is a flatten mask, used by fastai segmentation models.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Target: 20xClass0</span>
<span class="n">x2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span> <span class="n">x2</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(tensor([[[0.]],
 
         [[0.]],
 
         [[0.]],
 
         [[0.]],
 
         [[0.]]]),
 torch.Size([20, 1, 1]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Test of <code>DiceMulti</code> into a simulated training with <code>compute_val</code> and a test Learner with <code>TstLearner</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">compute_val</span><span class="p">(</span><span class="n">dice_obj</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">),</span> <span class="mf">1.</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Target: 20xClass1</span>
<span class="c1"># Dice metric = 0</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">compute_val</span><span class="p">(</span><span class="n">dice_obj</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">),</span> <span class="mf">0.</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Different scenario with a multiclass batch:</p>
<ul>
<li>Class0 x 10</li>
<li>Class1 x 4</li>
<li>Class2 x 3</li>
<li>Class4 x 3</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x2a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">x2b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">x2c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
<span class="n">x2d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span>

<span class="n">x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x2a</span><span class="p">,</span><span class="n">x2b</span><span class="p">,</span><span class="n">x2c</span><span class="p">,</span><span class="n">x2d</span><span class="p">),</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>   <span class="c1"># Target: 10xClass0, 4xClass1, 3xClass2, 3xClass4</span>
<span class="n">x2</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>torch.Size([20, 1, 1])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dice1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">10</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="mi">3</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span>              <span class="c1"># Dice: 2*TP/(2*TP+FP+FN)</span>
<span class="n">dice2</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">dice3</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">dice4</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># Value to be tested</span>
<span class="n">computed_dice</span> <span class="o">=</span> <span class="n">compute_val</span><span class="p">(</span><span class="n">dice_obj</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
<span class="c1"># Dice metric = 0.1666</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">computed_dice</span><span class="p">,</span> <span class="p">(</span><span class="n">dice1</span><span class="o">+</span><span class="n">dice2</span><span class="o">+</span><span class="n">dice3</span><span class="o">+</span><span class="n">dice4</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="p">[</span><span class="n">dice1</span><span class="p">,</span> <span class="n">dice2</span><span class="p">,</span> <span class="n">dice3</span><span class="p">,</span> <span class="n">dice4</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">computed_dice</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[[0.6666666666666666, 0, 0, 0]]
0.16666666666666666
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dice_obj</span><span class="o">.</span><span class="n">inter</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{0: 10.0, 1: 0.0, 2: 0.0, 3: 0.0}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dice_obj</span><span class="o">.</span><span class="n">union</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{0: 30.0, 1: 4.0, 2: 3.0, 3: 3.0}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">binary_dice_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">dice_obj</span><span class="o">.</span><span class="n">inter</span><span class="p">:</span>
    <span class="n">binary_dice_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">binary_dice_scores</span><span class="p">,</span> 
        <span class="mf">2.</span><span class="o">*</span><span class="n">dice_obj</span><span class="o">.</span><span class="n">inter</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">/</span><span class="n">dice_obj</span><span class="o">.</span><span class="n">union</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> 
        <span class="k">if</span> <span class="n">dice_obj</span><span class="o">.</span><span class="n">union</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">binary_dice_scores</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([0.66666667, 0.        , 0.        , 0.        ])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">binary_dice_scores</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.16666666666666666</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="KaggleDice" class="doc_header"><code>class</code> <code>KaggleDice</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L60" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>KaggleDice</code>(<strong><code>axis</code></strong>=<em><code>1</code></em>, <strong><code>eps</code></strong>=<em><code>1e-09</code></em>) :: <code>Metric</code></p>
</blockquote>
<p>Blueprint for defining a metric</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The competition "Evaluation" metric is defined as:</p>
<blockquote><p>This competition is evaluated on the mean Dice coefficient. The Dice coefficient can be used to compare the pixel-wise agreement between a predicted segmentation and its corresponding ground truth. The formula is given by:$$J(A,B) = \frac{2 * |A \cap B|}{|A| \cup |B|}
$$</p>
<p>where X is the predicted set of pixels and Y is the ground truth. The Dice coefficient is defined to be 1 when both X and Y are empty. The leaderboard score is the mean of the Dice coefficients for each &lt;ImageId, ClassId&gt; pair in the test set.</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dice_kaggle_obj</span> <span class="o">=</span> <span class="n">KaggleDice</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">computed_kaggle_dice</span> <span class="o">=</span> <span class="n">compute_val</span><span class="p">(</span><span class="n">dice_kaggle_obj</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">);</span> <span class="n">computed_kaggle_dice</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.7500000005</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Test for <a href="/steel_segmentation/metrics.html#KaggleDice"><code>KaggleDice</code></a>:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">20</span><span class="p">]</span>
<span class="n">intersect</span><span class="p">,</span> <span class="n">union</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span><span class="n">vals</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="n">targ</span> <span class="o">=</span> <span class="p">(</span> <span class="n">x2</span><span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span><span class="n">vals</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="p">)</span>
    <span class="n">targ</span> <span class="o">=</span> <span class="n">targ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-9</span>
    <span class="c1"># pred.shape, targ.shape</span>

    <span class="k">if</span> <span class="n">pred</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">targ</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="n">targ</span> <span class="o">=</span> <span class="n">targ</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">targ</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># n, c</span>

    <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">targ</span> <span class="o">=</span> <span class="n">targ</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># pred.shape, targ.shape</span>
    <span class="c1"># pred.max(), targ.max()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pred</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">targ</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">p</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">TensorBase</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">TensorBase</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">c_inter</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="c1">#.item()</span>
        <span class="n">c_union</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="c1">#.item()</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">intersect</span><span class="p">:</span>
            <span class="n">intersect</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">intersect</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">c_inter</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">union</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">union</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">c_union</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">intersect</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_inter</span>
            <span class="n">union</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_union</span>
    <span class="c1">#     print(f&quot;Iter n.{i}\nintersect: {intersect[i]}\nunion: {union[i]}&quot;, end=&quot;\n\n&quot;)</span>

<span class="n">binary_dice_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">intersect</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="n">union</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">val</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">intersect</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">+</span><span class="n">eps</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">union</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">+</span><span class="n">eps</span><span class="p">)</span>
    <span class="n">val</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">binary_dice_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">binary_dice_scores</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

<span class="n">num</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">binary_dice_scores</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="mi">20</span><span class="p">):((</span><span class="n">i</span><span class="o">*</span><span class="mi">20</span><span class="p">)</span><span class="o">+</span><span class="mi">20</span><span class="p">)])</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=.</span><span class="mi">6</span><span class="p">,</span> <span class="n">pad</span><span class="o">=-</span><span class="mf">7.</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">binary_dice_scores</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>0.7500000005
</pre>
</div>
</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
"
>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_close</span><span class="p">(</span><span class="n">computed_kaggle_dice</span><span class="p">,</span> <span class="n">binary_dice_scores</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Test <a href="/steel_segmentation/metrics.html#KaggleDice"><code>KaggleDice</code></a> with a real shape batch:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">chs</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">x3a</span> <span class="o">=</span> <span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">chs</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">0.65</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">x3b</span> <span class="o">=</span> <span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">chs</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">0.65</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">x3c</span> <span class="o">=</span> <span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">chs</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">0.65</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">x3d</span> <span class="o">=</span> <span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">chs</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">0.65</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">x3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x3a</span><span class="p">,</span><span class="n">x3b</span><span class="p">,</span><span class="n">x3c</span><span class="p">,</span><span class="n">x3d</span><span class="p">),</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span> <span class="n">x3</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>torch.Size([20, 4, 1, 1])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x4a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">x4b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">x4c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">x4d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">x4e</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">x4</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x4a</span><span class="p">,</span><span class="n">x4b</span><span class="p">,</span><span class="n">x4c</span><span class="p">,</span><span class="n">x4d</span><span class="p">,</span> <span class="n">x4e</span><span class="p">),</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>   <span class="c1"># Target: 5xClass0, 5xClass1, 5xClass2, 5xClass4</span>
<span class="n">x4</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>torch.Size([20, 4, 1])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">computed_kaggle_dice</span> <span class="o">=</span> <span class="n">compute_val</span><span class="p">(</span><span class="n">dice_kaggle_obj</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">x4</span><span class="p">);</span> <span class="n">computed_kaggle_dice</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.6232142878295888</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">20</span><span class="p">]</span>
<span class="n">intersect</span><span class="p">,</span> <span class="n">union</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">x3</span><span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span><span class="n">vals</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="n">targ</span> <span class="o">=</span> <span class="p">(</span> <span class="n">x4</span><span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span><span class="n">vals</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="p">)</span>
    <span class="n">targ</span> <span class="o">=</span> <span class="n">targ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-9</span>

    <span class="k">if</span> <span class="n">pred</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">targ</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="n">targ</span> <span class="o">=</span> <span class="n">targ</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">targ</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">targ</span> <span class="o">=</span> <span class="n">targ</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pred</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">targ</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">p</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">TensorBase</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">TensorBase</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">c_inter</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="c1">#.item()</span>
        <span class="n">c_union</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="c1">#.item()</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">intersect</span><span class="p">:</span>
            <span class="n">intersect</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">intersect</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">c_inter</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">union</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">union</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">c_union</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">intersect</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_inter</span>
            <span class="n">union</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_union</span>

<span class="n">binary_dice_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">intersect</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="n">union</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">val</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">intersect</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">+</span><span class="n">eps</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">union</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">+</span><span class="n">eps</span><span class="p">)</span>
    <span class="n">val</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">binary_dice_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">binary_dice_scores</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

<span class="n">num</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">binary_dice_scores</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="mi">20</span><span class="p">):((</span><span class="n">i</span><span class="o">*</span><span class="mi">20</span><span class="p">)</span><span class="o">+</span><span class="mi">20</span><span class="p">)])</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=.</span><span class="mi">6</span><span class="p">,</span> <span class="n">pad</span><span class="o">=-</span><span class="mf">7.</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">binary_dice_scores</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>0.6232142878295888
</pre>
</div>
</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
"
>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Real masks have a problem with the hardnegatives examples.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x3</span><span class="p">,</span> <span class="n">x4</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">targs</span>
<span class="n">x3</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">x4</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(torch.Size([20, 4, 256, 256]), torch.Size([20, 4, 256, 256]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">show_image</span><span class="p">(</span><span class="n">targs</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;AxesSubplot:&gt;</pre>
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
"
>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="dice_kaggle" class="doc_header"><code>dice_kaggle</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L105" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>dice_kaggle</code>(<strong><code>preds</code></strong>:<code>Tensor</code>, <strong><code>targs</code></strong>:<code>Tensor</code>, <strong><code>iou</code></strong>:<code>bool</code>=<em><code>False</code></em>, <strong><code>eps</code></strong>:<code>float</code>=<em><code>1e-08</code></em>)</p>
</blockquote>
<p>The metric of the competition,
if there's no defect in <code>targs</code> and no defects in <code>preds</code>: dice=1.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dice_kag</span> <span class="o">=</span> <span class="n">dice_kaggle</span><span class="p">(</span><span class="n">x3</span><span class="p">,</span> <span class="n">x4</span><span class="p">)</span>
<span class="n">dice_kag</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>TensorBase(0.7437)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_ne</span><span class="p">(</span><span class="n">computed_dice</span><span class="p">,</span> <span class="n">dice_kag</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Intersection-Over-Union">Intersection Over Union<a class="anchor-link" href="#Intersection-Over-Union"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="iou" class="doc_header"><code>iou</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L142" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>iou</code>(<strong><code>outputs</code></strong>:<code>Tensor</code>, <strong><code>targets</code></strong>:<code>Tensor</code>, <strong><code>eps</code></strong>:<code>float</code>=<em><code>1e-07</code></em>, <strong><code>threshold</code></strong>:<code>float</code>=<em><code>None</code></em>, <strong><code>activation</code></strong>:<code>str</code>=<em><code>'Sigmoid'</code></em>)</p>
</blockquote>
<p><a href="https://github.com/catalyst-team/catalyst/blob/master/catalyst/dl/utils/criterion/iou.py">https://github.com/catalyst-team/catalyst/blob/master/catalyst/dl/utils/criterion/iou.py</a>
Args:
    outputs (torch.Tensor): A list of predicted elements
    targets (torch.Tensor):  A list of elements that are to be predicted
    eps (float): epsilon to avoid zero division
    threshold (float): threshold for outputs binarization
    activation (str): An torch.nn activation applied to the outputs.
        Must be one of ["none", "Sigmoid", "Softmax2d"]
Returns:
    float: IoU (Jaccard) score</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="iou_binary_metric" class="doc_header"><code>iou_binary_metric</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L173" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>iou_binary_metric</code>(<strong><code>preds</code></strong>, <strong><code>labels</code></strong>, <strong><code>EMPTY</code></strong>=<em><code>1.0</code></em>, <strong><code>ignore</code></strong>=<em><code>None</code></em>, <strong><code>per_image</code></strong>=<em><code>True</code></em>)</p>
</blockquote>
<p>IoU for foreground class
binary: 1 foreground, 0 background</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="iou_metric" class="doc_header"><code>iou_metric</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L193" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>iou_metric</code>(<strong><code>preds</code></strong>, <strong><code>labels</code></strong>, <strong><code>C</code></strong>, <strong><code>EMPTY</code></strong>=<em><code>1.0</code></em>, <strong><code>ignore</code></strong>=<em><code>None</code></em>, <strong><code>per_image</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Array of IoU for each (non ignored) class</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="compute_ious" class="doc_header"><code>compute_ious</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L215" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>compute_ious</code>(<strong><code>pred</code></strong>, <strong><code>label</code></strong>, <strong><code>classes</code></strong>, <strong><code>ignore_index</code></strong>=<em><code>255</code></em>, <strong><code>only_present</code></strong>=<em><code>True</code></em>)</p>
</blockquote>
<p>computes IoU for one ground truth mask and predicted mask</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">x3</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x2</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">compute_ious</span><span class="p">(</span><span class="n">x1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">x3</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">classes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">only_present</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[0.0, 0.5, 1, 1]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">compute_ious</span><span class="p">(</span><span class="n">x1</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">x3</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">classes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">only_present</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[0.0, 0.5, 1, 1]
[0.0, 0.0, 1, 1]
[0.0, 0.0, 1, 1]
[0.0, 0.0, 1, 1]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="compute_iou_batch" class="doc_header"><code>compute_iou_batch</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L234" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>compute_iou_batch</code>(<strong><code>outputs</code></strong>, <strong><code>labels</code></strong>, <strong><code>classes</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>computes mean iou for a batch of ground truth masks and predicted masks</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">compute_iou_batch</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.25</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Dice">Dice<a class="anchor-link" href="#Dice"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="dice" class="doc_header"><code>dice</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L245" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>dice</code>(<strong><code>outputs</code></strong>:<code>Tensor</code>, <strong><code>targets</code></strong>:<code>Tensor</code>, <strong><code>eps</code></strong>:<code>float</code>=<em><code>1e-07</code></em>, <strong><code>threshold</code></strong>:<code>float</code>=<em><code>None</code></em>)</p>
</blockquote>
<p>Computes the binary dice metric
Args:
    outputs (list):  A list of predicted elements
    targets (list): A list of elements that are to be predicted
    eps (float): epsilon
    threshold (float): threshold for outputs binarization
Returns:
    double:  Dice score</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here there'are some functions used by the pure pytorch solution from a kaggle kernel.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="metric" class="doc_header"><code>metric</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L273" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>metric</code>(<strong><code>probability</code></strong>, <strong><code>truth</code></strong>, <strong><code>threshold</code></strong>=<em><code>0.5</code></em>, <strong><code>reduction</code></strong>=<em><code>'none'</code></em>)</p>
</blockquote>
<p>Calculates dice of positive and negative images seperately
<code>probability</code> and <code>truth</code> must be <code>torch.Tensors</code>.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">metric</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x3</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="predict" class="doc_header"><code>predict</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L305" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>predict</code>(<strong><code>X</code></strong>, <strong><code>threshold</code></strong>)</p>
</blockquote>
<p>X is sigmoid output of the model</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Meter" class="doc_header"><code>class</code> <code>Meter</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L312" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Meter</code>(<strong><code>phase</code></strong>, <strong><code>epoch</code></strong>)</p>
</blockquote>
<p>A meter to keep track of iou and dice scores throughout an epoch</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Meter.get_metrics" class="doc_header"><code>Meter.get_metrics</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L334" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Meter.get_metrics</code>()</p>
</blockquote>
<p>Calc the mean of dices metrics (dice, dice_neg, dice_pos)
and IoU mean.</p>
<p>Returns:
    <code>dices</code> as list of means <code>[dice, dice_neg, dice_pos]</code>,
    <a href="/steel_segmentation/metrics.html#iou"><code>iou</code></a> as mean of IoUs</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="epoch_log" class="doc_header"><code>epoch_log</code><a href="https://github.com/marcomatteo/steel_segmentation/tree/master/steel_segmentation/metrics.py#L353" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>epoch_log</code>(<strong><code>phase</code></strong>, <strong><code>epoch</code></strong>, <strong><code>epoch_loss</code></strong>, <strong><code>meter</code></strong>, <strong><code>start</code></strong>)</p>
</blockquote>
<p>logging the metrics at the end of an epoch</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

