---

title: Visualize results


keywords: fastai
sidebar: home_sidebar

summary: "An interactive notebook with IPywidgets to visualize model predictions and groundtruth."
description: "An interactive notebook with IPywidgets to visualize model predictions and groundtruth."
nb_path: "nbs/09_visualize.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/09_visualize.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="https://colab.research.google.com/github/marcomatteo/steel_segmentation/blob/master/nbs/09_visualize.ipynb"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">widgets</span>
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">interact</span><span class="p">,</span> <span class="n">interact_manual</span><span class="p">,</span> <span class="n">interactive</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="kn">from</span> <span class="nn">steel_segmentation.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastcore.all</span> <span class="kn">import</span> <span class="n">L</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">cv2</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Display-utilities">Display utilities<a class="anchor-link" href="#Display-utilities"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">submission_preproccessing</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a submission DataFrame and </span>
<span class="sd">    splits the ImageId_ClassId column into ImageId and ClassId.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s2">&quot;ImageId_ClassId&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing ImageId_ClassId column&quot;</span><span class="p">)</span>
        
    <span class="n">splitted_cols</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ImageId_ClassId&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ImageId&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ClassId&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">splitted_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">splitted_cols</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">read_submission</span><span class="p">(</span><span class="n">file_name</span><span class="p">:</span><span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ensemble_submission.csv&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Open a submission csv file in the `sub_path` directory and</span>
<span class="sd">    return the DataFrame preprocessed with `submission_preproccessing`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">sub_path</span> <span class="o">/</span> <span class="n">file_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">submission_preproccessing</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">file</span> <span class="o">=</span> <span class="s2">&quot;ensemble_submission.csv&quot;</span>
<span class="n">file_df</span> <span class="o">=</span> <span class="n">read_submission</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
<span class="n">file_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ImageId_ClassId</th>
      <th>EncodedPixels</th>
      <th>ImageId</th>
      <th>ClassId</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0000f269f.jpg_1</td>
      <td>NaN</td>
      <td>0000f269f.jpg</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0000f269f.jpg_2</td>
      <td>NaN</td>
      <td>0000f269f.jpg</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0000f269f.jpg_3</td>
      <td>146418 5 146424 1 146577 30 146608 1 146610 1 146612 21 146638 48 146732 69 146802 1 146808 1 146810 1 146812 1 146820 125 146962 1 146976 225 147208 249 147461 252 147716 253 147971 254 148227 254 148483 254 148739 254 148995 254 149251 254 149507 254 149763 254 150019 254 150275 254 150532 253 150788 253 151045 252 151303 250 151563 246 151848 11 151862 13 151876 189 152152 169 152430 29 152489 1 152491 1 152493 6 152500 7 152557 12</td>
      <td>0000f269f.jpg</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0000f269f.jpg_4</td>
      <td>NaN</td>
      <td>0000f269f.jpg</td>
      <td>4</td>
    </tr>
    <tr>
      <th>4</th>
      <td>000ccc2ac.jpg_1</td>
      <td>NaN</td>
      <td>000ccc2ac.jpg</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Display a sample of 5 images from <a href="/steel_segmentation/metadata.html#train_path"><code>train_path</code></a>:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sample_images_from_path</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">train_path</span><span class="p">)))</span><span class="o">.</span><span class="n">shuffle</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]</span>

<span class="nd">@interact_manual</span> 
<span class="k">def</span> <span class="nf">show_images</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">sample_images_from_path</span><span class="p">):</span>
    <span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">train_path</span><span class="o">/</span><span class="n">file</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Display-a-test-submission">Display a test submission<a class="anchor-link" href="#Display-a-test-submission"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Per visualizzare un campione di 5 immagini, selezionare dall'elenco a discesa la <em>submission</em> e successivamente la <em>ClassId</em> e infine il nome dell'immagine.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">subs</span> <span class="o">=</span><span class="p">[</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sub_path</span><span class="p">))</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">)]</span>

<span class="k">def</span> <span class="nf">read_sub_file_from_list</span><span class="p">(</span><span class="n">sub</span> <span class="o">=</span> <span class="n">subs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">read_submission</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">submission_preproccessing</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">select_classid</span><span class="p">(</span><span class="n">ClassId</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">submission</span><span class="o">.</span><span class="n">result</span>
    <span class="n">cond_NaN</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">EncodedPixels</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
    <span class="n">cond_ClassId</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ClassId&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ClassId</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond_NaN</span> <span class="o">&amp;</span> <span class="n">cond_ClassId</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">update_imgids</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">images</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">class_selection</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span><span class="o">.</span><span class="n">ImageId</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">submission</span> <span class="o">=</span> <span class="n">interactive</span><span class="p">(</span><span class="n">read_sub_file_from_list</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">submission</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">submission</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">update_imgids</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>

<span class="n">class_selection</span> <span class="o">=</span> <span class="n">interactive</span><span class="p">(</span><span class="n">select_classid</span><span class="p">)</span>
<span class="n">int_slider</span> <span class="o">=</span> <span class="n">class_selection</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">int_slider</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">int_slider</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">50</span>

<span class="n">class_selection</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">class_selection</span><span class="o">.</span><span class="n">result</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">ImageId</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>

<span class="c1"># Show the images</span>
<span class="k">def</span> <span class="nf">show_images</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;ImageId&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">file</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rle</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;EncodedPixels&quot;</span><span class="p">]</span>
    <span class="n">classid</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;ClassId&quot;</span><span class="p">]</span>
    
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">1600</span><span class="p">)</span>
    <span class="n">masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="c1"># 4:class 1～4 (ch:0～3)</span>
    <span class="n">masks</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">classid</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rle2mask</span><span class="p">(</span><span class="n">rle</span><span class="o">=</span><span class="n">rle</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">))</span>
    
    <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">test_path</span><span class="o">/</span><span class="n">file</span><span class="p">))</span>
    <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Image </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> with defect type: </span><span class="si">{</span><span class="n">classid</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">plot_mask_image</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">img</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">masks</span><span class="p">)</span>

<span class="n">sub_img</span> <span class="o">=</span> <span class="n">interactive</span><span class="p">(</span><span class="n">show_images</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">images</span><span class="p">)</span>
<span class="n">sub_img</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Compare">Compare<a class="anchor-link" href="#Compare"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Per visualizzare invece immagini dal training o test set:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Create widgets</span>
<span class="n">directory</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">train_path</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">test_path</span><span class="p">)])</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">directory</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>

<span class="c1"># Updates the image options based on directory value</span>
<span class="k">def</span> <span class="nf">update_images</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">images</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">directory</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="c1"># Tie the image options to directory value</span>
<span class="n">directory</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">update_images</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>

<span class="c1"># Show the images</span>
<span class="k">def</span> <span class="nf">show_images</span><span class="p">(</span><span class="n">fdir</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
    <span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fdir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">interactive</span><span class="p">(</span><span class="n">show_images</span><span class="p">,</span> <span class="n">fdir</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">images</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">show_images</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
    <span class="n">plot_defected_image</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">train_path</span><span class="p">)</span><span class="o">/</span><span class="n">file</span><span class="p">)</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">interactive</span><span class="p">(</span><span class="n">show_images</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">images</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">select_valid_classid</span><span class="p">(</span><span class="n">ClassId</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">read_sub_file_from_list</span><span class="p">(</span><span class="s2">&quot;ensemble_validation.csv&quot;</span><span class="p">)</span>
    
    <span class="n">cond_NaN</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">EncodedPixels</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
    <span class="n">cond_ClassId</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ClassId&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ClassId</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond_NaN</span> <span class="o">&amp;</span> <span class="n">cond_ClassId</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>    
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">update_imgids</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">images</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">class_selection</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span><span class="o">.</span><span class="n">ImageId</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Tie the image options to submission value</span>
<span class="n">submission</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">update_imgids</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>

<span class="n">class_selection</span> <span class="o">=</span> <span class="n">interactive</span><span class="p">(</span><span class="n">select_valid_classid</span><span class="p">)</span>
<span class="n">int_slider</span> <span class="o">=</span> <span class="n">class_selection</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">int_slider</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">int_slider</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">display</span><span class="p">(</span><span class="n">class_selection</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">class_selection</span><span class="o">.</span><span class="n">result</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">ImageId</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>

<span class="c1"># Show the images</span>
<span class="k">def</span> <span class="nf">show_images</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;ImageId&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">file</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rle</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;EncodedPixels&quot;</span><span class="p">]</span>
    <span class="n">classid</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;ClassId&quot;</span><span class="p">]</span>
    
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">1600</span><span class="p">)</span>
    <span class="n">masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="c1"># 4:class 1～4 (ch:0～3)</span>
    <span class="n">masks</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">classid</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rle2mask</span><span class="p">(</span><span class="n">rle</span><span class="o">=</span><span class="n">rle</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">))</span>
    
    <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">train_path</span><span class="o">/</span><span class="n">file</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Detected: Image </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> with defect type </span><span class="si">{</span><span class="n">classid</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">plot_mask_image</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">img</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">masks</span><span class="p">)</span>
    
    <span class="n">plot_defected_image</span><span class="p">(</span><span class="n">train_path</span><span class="o">/</span><span class="n">file</span><span class="p">,</span> <span class="n">classid</span><span class="p">)</span>

<span class="n">sub_img</span> <span class="o">=</span> <span class="n">interactive</span><span class="p">(</span><span class="n">show_images</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">images</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">sub_img</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

